<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Access Code Unlock</title>
<style>
  /* ===== Base & Center ===== */
  html, body { height:100%; }
  body{
    margin:0; padding:0;
    background:#000; color:#fff;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    display:flex; align-items:center; justify-content:center;
    overflow:hidden; /* กันเลื่อนขณะล็อก */
  }
  body.locked{ overflow:hidden; }

  /* ===== Overlay wrapper (เผื่ออนาคตอยากเปิด/ปิด overlay) ===== */
  #screen-lock{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:#000; z-index:9999;
  }

  /* ===== Glass Box ===== */
  .login-box{
    width: min(92vw, 420px);
    padding: 32px 26px;
    border-radius: 22px;
    text-align:center;

    /* glass + ขอบขาวหนาชัด */
    background: rgba(255,255,255,0.10);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 2px solid rgba(255,255,255,0.95);
    box-shadow: 0 12px 36px rgba(0,0,0,0.65);
  }

  .login-box h2{
    margin: 0 0 18px;
    font-size: 26px;
    font-weight: 800;
    color:#fff;
  }

  /* ===== Message ===== */
  #msg{
    display:none;
    margin: 0 0 12px;
    padding: 10px 12px;
    border-radius: 12px;
    border:2px solid #fff; /* ให้ล้อกับธีมเส้นหนา */
    text-align:left;
    font-size:14px;
  }
  #msg.error{ display:block; background: rgba(255,77,79,0.15); }
  #msg.success{ display:block; background: rgba(82,196,26,0.15); }

  /* ===== Fields (pill + เส้นขาวหนา) ===== */
  .field{
    display:flex; align-items:center; gap:10px;
    margin-bottom: 14px;
    padding: 12px 16px;
    border-radius: 999px;
    border: 2px solid #fff;               /* เส้นขาวหนา */
    background: rgba(255,255,255,0.06);
  }
  .field select,
  .field input{
    flex:1; min-width:0;
    background:transparent; border:0; outline:0;
    color:#fff; font-size:15px;
  }
  .field select{ cursor:pointer; }
  .hint{ font-size:12px; opacity:.8; margin:-6px 6px 8px; text-align:left; }

  /* ===== Button ===== */
  #unlock-btn{
    width:100%;
    padding: 12px 18px;
    border-radius: 999px;
    font-size: 16px; font-weight: 700;
    border: 2px solid #fff;               /* เส้นขาวหนาเหมือนในรูป */
    background: #fff; color:#000;
    cursor:pointer; transition: .2s;
  }
  #unlock-btn:hover{ opacity:.9; }
  #unlock-btn[disabled]{ opacity:.7; cursor:not-allowed; }

  /* loading spinner ในปุ่ม */
  .btn-loading{ position:relative; color:transparent !important; }
  .btn-loading::after{
    content:"";
    position:absolute; inset:0; margin:auto;
    width:18px; height:18px; border-radius:50%;
    border:2px solid rgba(0,0,0,.25); border-top-color:#000;
    animation: spin .8s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg); } }

  /* ===== Countdown ===== */
  #countdown-timer{ margin-top: 12px; font-size: 12px; opacity:.9; }

  /* เขย่ากล่องตอน error (เบาๆ) */
  @keyframes shakeX { 10%,90%{transform:translateX(-1px)} 20%,80%{transform:translateX(2px)} 30%,50%,70%{transform:translateX(-4px)} 40%,60%{transform:translateX(4px)} }
  .shake{ animation: shakeX .35s ease; }
</style>
</head>
<body class="locked">
  <div id="screen-lock">
    <div class="login-box" id="lock-box" role="dialog" aria-modal="true" aria-labelledby="title">
      <h2 id="title">Login</h2>

      <div id="msg"></div>

      <!-- Duration -->
      <div class="field">
        <select id="duration-select" aria-label="Access duration">
          <option value="minute">1 minute</option>
          <option value="day">1 day (Free code : )</option>
          <option value="7days">7 days</option>
          <option value="30days">30 days</option>
        </select>
      </div>
      <div class="hint">Choose your access duration</div>

      <!-- Access Code -->
      <div class="field">
        <input id="access-input" type="text" placeholder="Access code" autocomplete="one-time-code" inputmode="text" />
      </div>

      <button id="unlock-btn">Login</button>
      <div id="countdown-timer"></div>
    </div>
  </div>

<script>
  /* ===== Helpers: lock / unlock ===== */
  function lockScreen(){
    document.body.classList.add('locked');
    document.getElementById('screen-lock').style.display='flex';
  }
  function unlockScreen(){
    document.body.classList.remove('locked');
    document.getElementById('screen-lock').style.display='none';
    document.body.style.backgroundColor = "#000"; // คงพื้นหลังดำหลังปลดล็อก
  }

  /* ===== Expiration ===== */
  function getExpirationTime(type, value){
    const now = new Date();
    if(type==="minute") now.setMinutes(now.getMinutes()+value);
    else if(type==="day") now.setDate(now.getDate()+value);
    return now.getTime();
  }
  const durationMap = {
    minute:{ type:"minute", value:1 },
    day:{ type:"day", value:1 },
    "7days":{ type:"day", value:7 },
    "30days":{ type:"day", value:30 }
  };

  /* ===== Countdown ===== */
  let countdownInterval;
  function startCountdown(expire){
    clearInterval(countdownInterval);
    const el = document.getElementById("countdown-timer");
    countdownInterval = setInterval(()=>{
      const now = Date.now(), d = expire - now;
      const days = Math.floor(d/(1000*60*60*24));
      const h = Math.floor((d%(1000*60*60*24))/(1000*60*60));
      const m = Math.floor((d%(1000*60*60))/(1000*60));
      const s = Math.floor((d%(1000*60))/1000);
      el.textContent = d>0 ? `Time remaining: ${days?days+"d ":""}${h}h ${m}m ${s}s` : "Expired! Please re-enter the code.";
      if(d<0){
        clearInterval(countdownInterval);
        lockScreen();
        localStorage.removeItem("access_granted");
        localStorage.removeItem("expiration_time");
      }
    },1000);
  }

  /* ===== Restore session ===== */
  (function restore(){
    const ok = localStorage.getItem("access_granted");
    const exp = localStorage.getItem("expiration_time");
    if(ok && exp){
      const t = parseInt(exp,10);
      if(Date.now() < t){
        unlockScreen();
        window.scrollTo(0,0);
        startCountdown(t);
        window.AppInventor?.setWebViewString("unlocked");
      }else{
        localStorage.removeItem("access_granted");
        localStorage.removeItem("expiration_time");
      }
    }
  })();

  /* ===== UI feedback ===== */
  function showMsg(type, text){
    const el = document.getElementById('msg');
    el.className = type || '';
    el.textContent = text || '';
    el.style.display = text ? 'block' : 'none';
    const box = document.getElementById('lock-box');
    box.classList.remove('shake'); void box.offsetWidth; box.classList.add('shake');
  }
  function setLoading(state){
    const btn = document.getElementById('unlock-btn');
    btn.disabled = state;
    btn.classList.toggle('btn-loading', state);
  }

  /* ===== Submit ===== */
  async function doUnlock(){
    const input = document.getElementById('access-input');
    const code = input.value.trim();
    const selected = document.getElementById('duration-select').value;
    if(!code){
      showMsg('error','Please enter your access code.');
      input.focus();
      return;
    }
    const url = "https://script.google.com/macros/s/AKfycbxpgnHFx25XGdA-8yfP_17e_GqcremB5qqBlWaJ0yIUxQb4mc6o01TYPFS8TKt8nWQ/exec?code="
      + encodeURIComponent(code) + "&type=" + encodeURIComponent(selected);

    showMsg('', ''); setLoading(true);
    try{
      const r = await fetch(url);
      const result = await r.text();
      if(result === "valid"){
        const expire = getExpirationTime(durationMap[selected].type, durationMap[selected].value);
        localStorage.setItem("access_granted","true");
        localStorage.setItem("expiration_time", String(expire));
        unlockScreen();
        window.scrollTo(0,0);
        startCountdown(expire);
        window.AppInventor?.setWebViewString("unlocked");
        showMsg('success','Unlocked successfully.');
      }else{
        showMsg('error','Invalid access code.');
        input.focus();
      }
    }catch(e){
      console.error(e);
      showMsg('error','Error connecting to server. Please try again.');
    }finally{
      setLoading(false);
    }
  }

  document.getElementById('unlock-btn').addEventListener('click', doUnlock);
  document.getElementById('access-input').addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); doUnlock(); }
  });

  /* เริ่มต้นล็อกไว้ */
  lockScreen();
</script>
</body>
</html>
